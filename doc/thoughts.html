<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Music Trainer - размышления</title>
  </head>
  <body>
    <h2>Из Plans Plant</h2>
    Тексты из задач:
    <h3>Music Trainer</h3>
    Приложение для заучивания пьес на фортепиано (синтезаторе)
    <ul>
      <li>Ориентировано на планшет, установленный на синтезаторе альбомно (ибо у меня пюпитр хлипкий).</li>
      <li>Обязательно: выбор дорожек MIDI-файла, выбор фрагмента, изменине темпа.</li>
      <li>Далее: ограничение громкости (скорости) и отклонения от метронома.</li>
      <li>Затем: нотки и, вероятно, клавиши</li>
      <li>После: редактирование MIDI</li>
    </ul>
    <h3>Обучение игре на клавишах (новый BoardTrainer)</h3>
    <p>Видимо, мультиплатформенный (или только Linux)</p>
    <p>Кроме, собственно, обучения игре на ф-но  (разучивание и повторение упражнений и пьес) хорошо бы добавить упражнения на развитие слуха:
      <ol>
	<li>Сравнение интервалов</li>
	<li>Определение интервалов</li>
	<li>Игра ритма</li>
	<li>Ритмический диктант</li>
	<li>Повторение ритма</li>
	<li>Определение нот</li>
	<li>Пение нот - случайных для развития слуха и последовательных для развития точности и диапозона (при этом в случае ошибки можно повторять ноту, пока она не будет спета правильно).</li>
	<li>Игра нот с нотоносца</li>
      </ol>
    </p>
    <p>Приложение предположительно будет кроссплатформенным под Linux и Windows, из основных настроек планируется сделать выбор входов и параметров аудио. Возможно будет сделано объединение нескольких
      аудиовходов в многодорожечный файл (здесь надо учитывать, что у разных карт могут несколько отличаться точные частоты дискретизации, тогда они рассинхронизируются).
    <h2>Функции</h2>
    <ul>
      <li>Обучение игре на музыкальных инструментах с MIDI-интерфейсом</li>
      <li>Развитие слуха</li>
      <li>Эффекты для MIDI-клавиатуры: транспозиция, разделение клавиатуры, автоматическая смена инструментов, контроллеры и т.п.</li>
      <li>Сопровождение - дополнительные инструменты (из MIDI-трека), автоаккомпанимент, ритмы, аудиодорожки.</li>
      <li>Автопрокручиваемый нотоносец (при разучивании и воспроизведении) в первом случае нужно специально подсвечивать текущую позицию, ошибочные и неидеальные ноты. Сам нотоносец может прокручиваться
	горизонтально, если партий достаточно много по сравнению с высотой экрана (или просто так удобнее) или может быть несколько строк, как обычно на странице в нотной тетради, тогда они
	прокручиваются по вертикали.</li>
      <li>Музыкальный редактор (на нотоносце) с дополнительными (по сравнению с MIDI-файлами) элементами, например, номерами пальцев для ф-но.</li>
      <li>Запись игры на инструменте в MIDI-файл.</li>
      <li>Запись аудиодорожек с возможностью выбора отдельных каналов (например, у меня микрофон на левом канале, а на правом ничего нет.</li>
    </ul>
    <h2>Обучение</h2>
    <p>Приложение поддерживает три типа упражнений: запись нотами, игра на MIDI-инструменте (возможно, виртуальном) и захват с аудиоустройства (микрофона). В первых двух случаях вход у нас довольно простой, а главное дискретный. Во втором - аналоговый, и для определения ноты нужно определить частоту при помощи быстрого преобразования Фурье (FFT) (надо бы поискать альтернативы с хорошим разрешением как по времени, так и по частоте). При этом он попадает в ноту только с определённой погрешностью. Следует отметить, что, возможно, следует использовать два преобразования, одно с большей точностью на длинном отрезке, а другое - короткое для отлова заметных краткосрочных отклонений.</p>
    <h3>Упражнения без инструмента</h3>
    Программа играет пример - отдельные ноты, интервалы, созвучия или мелодии, а пользователь должен либо нажать кнопку, соответствующую выбранному варианту, либо ввести ноты на нотоносце (или нитке). Во втором случае нужен редактор. В любом случае программа представляет готовый пример, а пользователь даёт готовый ответ. Программа их сравнивает и решает. Пользователь имеет возможность повторно прослушать пример или свой ответ до того, как он готов.
    <ul>
      <li>Сравнение интервалов</li>
      <li>Определение интервалов</li>
      <li>Определение аккордов</li>
      <li>Определение строя/тональности</li>
      <li>Определение нот (запись на нотоносце)</li>
      <li>Ритмический диктант</li>
      <li>Мелодический диктант</li>
    </ul>
    <h3>Упражнение на инструменте</h3>
    Этот тип упражнений отличается тем, что ответ готовится и анализируется в реальном времени. Ошибки сразу же отображаются на нотоносце.
    <ul>
      <li>Разучивание/повтор партий - основная задача приложения. Берём исходный MIDI-файл, на основе него создаются упражнения: фрагмент пьесы по времени, скорость (в процентах от исходного), треки, которые играем, треки, которые воспроизводятся. Для MIDI-клавиатуры (или устройства, которое может не озвучивать самостоятельно нажатые клавиши, мой синтезатор, например, играет их обязательно) могут быть также заданы преобразования перед передачей на синтезатор.</li>
      <li>Игра ритма с листа</li>
      <li>Повторение ритма</li>
      <li>Игра с листа (отдельных нот без темпа и мелодий)</li>
      <li>Повтор отдельных нот (или созвучий?). Возможно несколько попыток или до правильного ответа.</li>
    </ul>
    <h4>Сценарий изучения</h4>
    <p>Упражнение или пьеса записывается в файл MIDI. При этом партии левой и правой руки разносятся по разным каналам. Всё упражнение делится на части. После этого отдельно для каждой руки разучивается
      каждая часть. Считается, что часть освоена, когда она сыграна 3 раза подряд на нормальной скорости без ошибок. Разучивание начинается без проверки скорости, после трёх правильных раз подряд
      включается метроном на 50%, после чего скорость увеличивается в 1,5 раза. После трёх неудачных попыток подряд, скорость снижается. После того, как разучена каждая часть для каждой руки, она разучивается целиком (возможно, не сразу, а постепенно укрупняя фрагменты). Число повторов (3), начальную скорость (50%) и ускорение (x1,5) можно менять.</p>
    <p>После того, как пьеса разучена, она повторяется каждый день. После того, как она была сыграна без ошибок (по 3 раза подряд) 3 дня подряд, её можно играть один раз в день. Потом - в неделю, месяц, 3 месяца, год. В случае ошибки надо сыграть 3 раза подряд и происходит возврат к предыдущему режиму.</p>
      <h3>Упражнения с аудиовходом (микрофоном)</h3>
    Здесь воспроизводится или отображается нота, а ответ воспринимается с микрофона в реальном времени. Если в предыдущих типах ноты всегда точные, то здесь звук может быть довольно далеко от ноты и точность следует задавать. Для её увеличения на низких частотах придётся увеличивать длительность. Интервал задаётся (поскольку у голоса он довольно ограничен). Некоторые упражнения могут быть применены для аналоговых музыкальных инструментов, например, для гитары (те, которые не на точность попадания, а на верный выбор нот).
    <ul>
      <li>Тренировка пения нот - необходимо спеть ноты (последовательности могут быть разными: все неальтерированные, затем альтерированные на выбранном диапозоне вверх и вниз, случайно, из мелодии и т.д.) с заданной громкостью, точностью и длительностью. Попытки не ограничены ни по числу, ни по времени, т.к. задача спеть, а не услышать.</li>
      <li>Попадание в ноты - проверяется, насколько точно спета прозвучавшая нота. Точность и число попыток могут задаваться в параметрах. Последовательность может быть случайной или из мелодии</li>
      <li>Пение интервалов - требуется спеть указанный интервал к сыгранной ноте. Точность и число попыток могут задаваться в параметрах.</li>
      <li>Пение мелодии - требуется спеть прозвучавшую мелодию. Может проверяться не точность попадания в ноты, а правильность взятых нот. Это относится к относительно низким нотам короткой длительности - FFT просто не может определить частоту достаточно точно.</li>
      <li>Игра созвучий на музыкальном инструменте (или хоровое пение) - оценивается точность и правильность нот из созвучия.</li>
    </ul>
    <h2>Структура проекта</h2>
    <p>Проект состоит из следующих компонентов:
      <ul>
	<li><strong>Подсистема MIDI</strong> <code>lib/midi</code> обеспечивает работу с MIDI-устройствами и MIDI-файлами (в обоих случаях это и ввод, и вывод), системно-зависимые элементы содержатся
	в подкаталогах linux, windows или mac для соответствующих платформ. Для начала только linux</li>
	<li><strong>Подсистема аудио</strong> <code>lib/audio</code> воспроизводит и записывает аудиотреки, позволяет определить спектр сигнала, иногда вместо сырого аудио "в реальном времени" (на самом
	  деле с некоторой задержкой, необходимой для получения достаточного количества сэмплов для FFT, при этом спектров может быть несколько - один для точного определения и второй для отлова
	  кратковременных значительных отклонений). Возможно, в будущем будут добавлены цифровые эффекты, в т.ч. подключаемые, лучше взять готовые из какого-нибудь JACKа. Системно зависимый код аналогично
	  подсистеме MIDI.</li>
	<li><strong>Модуль обучения</strong> <code>lib/training</code> определяет упражнения, показывает или воспроизводит пример, принимает и сравнивает результат, сохраняет и читает упражнения, уроки,
	  курсы обучения и статистику в/из файлов. Должна быть возможность подключения упражнений в виде плагинов, но при этом в плагине получается некоторое пересечение модулей: логика упражнения как
	  бы относится сюда, а настройка и отображение - к интерфейсу.</li>
	<li><strong>Графический интерфейс</strong> <code>lib/gui</code> реализует взаимодействие с пользователем: отображение упражнений и результатов обучения, возможно, в реальном времени на нотоносце,
	  настройка упражнений, отображение статистики, редактирование музыкальных партий, работу с различными треками и вспомогательные элементы, такие как графики спектра, микшеры, MIDI-эффекты
	  (включая ритмы, автоаккомпанимент, транспонирование, разделение, смену инструмента и т.д.). Выполнен в виде набора виджетов Qt, возможно, подключаемых с помощью плагина Qt в дизайнер.</li>
	<li><strong>Консольные приложения</strong> <code>cli</code> приложения с интерфейсом командной строки, как MIDI-проигрыватель. Содержат разбор командрой строки, создание и запуск объектов из
	  библиотек.</li>
	<li><strong>Основное приложение с графическим интерфейсом</strong> <code>app</code> - содержит объект приложения и главное окно, управляющие объектами из библиотек.</li>
      </ul>
    </p>
    <h3>Подсистема MIDI</h3>
    <p>Взаимодействие с MIDI-объектами, которыми могут быть устройства ввода-вывода с интерфейсом MIDI, такие как синтезаторы, клавиатуры и другие контроллеры, MIDI-файлы и программные генераторы,
      например, метроном или другой генератор ритма и автоаккомпаниатор, реализуется при помощи источников (Source), пунктов назначения (Destination), событий (Event), их последовательностей (Sequence)
      и синхронизаторов (Synchronizer). Последние нужны для совмещения времени, которое может иметь различные точки отсчёта, например, в MIDI-файле, аудиодорожке и синтезаторе.

    <h2>План реализации</h2>
    <p>На начальном этапе:<ul>
	<li>Чтение MIDI-файлов, ввод и вывод под Linux (и, возможно, Windows из BoardTrainer'а)</li>
	<li>Метроном</li>
	<li>Сравнение ввода с MIDI-устройства с выбранным фрагментом файла (по времени и дорожкам). Отслеживается только точное совпадение да/нет. Пропущенные, лишние, неверные ноты не определяются.</li>
	<li>Выбор устройств ввода/вывода из списка</li>
	<li>Настройка основных параметров упражнения: выбор файла, дорожек и времени начала/окончания (в тактах и долях, т.е. для 4/4 5:4 - начало с последней доли пятого такта, доля с двоеточием
	  может отсутствовать, что означает начало такта), темпа в процентах от заданного в файле</li>
	<li>Отображение успешности выполнения</li>
	<li>Завершение после трёх успешных повторов подряд (или по сигналу пользователя)</li>
      </ul>
  </body>
</html>
